#!/usr/bin/env bash

# Requiere: cwebp, find, sed
# Requiere: chmod +x serve-optimized
# Uso: ./serve-optimized

POSTS_DIR="_posts"
IMAGES_DIR="assets/posts"

echo "üîç Convirtiendo links en posts de .png a .webp..."
for post in $POSTS_DIR/*.md; do
  # Reemplaza .png por .webp en los posts (solo en links/im√°genes)
  sed -i 's/\.png/.webp/g' "$post"
done

echo "üñº Procesando im√°genes en $IMAGES_DIR..."
find "$IMAGES_DIR" -type d ! -path "*/png" | while read -r dir; do
  for img in "$dir"/*.png; do
    [ -e "$img" ] || continue

    base=$(basename "$img" .png)
    subdir="$dir/png"

    mkdir -p "$subdir"

    # Convierte a webp solo si no existe
    if [ ! -f "$dir/$base.webp" ]; then
      echo "‚û°Ô∏è  Convirtiendo: $img ‚Üí $dir/$base.webp"
      cwebp -q 80 "$img" -o "$dir/$base.webp"
    fi

    # Mueve el PNG original
    mv "$img" "$subdir/"
  done
done

POSTS_DIR="_posts"

echo "üîç Convirtiendo im√°genes en posts..."

find "$POSTS_DIR" -type f -name "*.md" | while read -r post; do
  echo "Procesando $post"
  # Regex: busca {{ base.url }}/assets/posts/... .png ‚Üí .webp
  sed -i -E 's|(\{\{ *base\.url *\}\}/assets/posts/[^)]+)\.png|\1.webp|g' "$post"
done

echo "‚úÖ Listo!"


echo "üöÄ Iniciando Jekyll..."
bundler exec jekyll serve
